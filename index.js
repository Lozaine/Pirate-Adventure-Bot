require('dotenv').config({ override: true });
const { Client, GatewayIntentBits, Collection } = require('discord.js');
const fs = require('fs');
const path = require('path');
const config = require('./config.js');
const database = require('./database/postgresDatabase.js');

// Create Discord client
const client = new Client({
    intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildMessages,
        GatewayIntentBits.MessageContent
    ]
});

// Initialize commands collection
client.commands = new Collection();
client.cooldowns = new Collection();

// Load command files
const commandsPath = path.join(__dirname, 'commands');
const commandFiles = fs.readdirSync(commandsPath).filter(file => file.endsWith('.js'));

for (const file of commandFiles) {
    const filePath = path.join(commandsPath, file);
    const command = require(filePath);
    if ('data' in command && 'execute' in command) {
        client.commands.set(command.data.name, command);
        console.log(`[INFO] Loaded command: ${command.data.name}`);
    } else {
        console.log(`[WARNING] Command at ${filePath} is missing required "data" or "execute" property.`);
    }
}

// Bot ready event
client.once('ready', async () => {
    console.log(`[INFO] ${client.user.tag} is online!`);
    console.log(`[INFO] Bot is running on ${client.guilds.cache.size} servers`);
    
    // Initialize database
    await database.initialize();
    
    // Register slash commands globally
    try {
        const commands = [];
        client.commands.forEach(command => {
            commands.push(command.data.toJSON());
        });
        
        await client.application.commands.set(commands);
        console.log(`[INFO] Successfully registered ${commands.length} slash commands globally.`);
    } catch (error) {
        console.error('[ERROR] Failed to register slash commands:', error);
    }
});

// Handle all interactions (commands and components)
client.on('interactionCreate', async interaction => {
    // Handle autocomplete interactions
    if (interaction.isAutocomplete()) {
        const command = client.commands.get(interaction.commandName);
        if (!command || !command.autocomplete) {
            console.error(`[ERROR] No autocomplete method found for ${interaction.commandName}.`);
            return;
        }

        try {
            await command.autocomplete(interaction);
        } catch (error) {
            console.error(`[ERROR] Error executing autocomplete for ${interaction.commandName}:`, error);
        }
    }
    
    // Handle slash commands
    else if (interaction.isChatInputCommand()) {
        const command = client.commands.get(interaction.commandName);
        if (!command) {
            console.error(`[ERROR] No command matching ${interaction.commandName} was found.`);
            return;
        }

        try {
            await command.execute(interaction, client);
        } catch (error) {
            console.error(`[ERROR] Error executing ${interaction.commandName}:`, error);
            
            const errorMessage = {
                content: '‚ùå There was an error while executing this command!',
                ephemeral: true
            };
            
            if (interaction.replied || interaction.deferred) {
                await interaction.followUp(errorMessage);
            } else {
                await interaction.reply(errorMessage);
            }
        }
    }
    
    // Handle button interactions
    else if (interaction.isButton()) {
        // Handle combat button interactions
        if (interaction.customId.startsWith('combat_')) {
            try {
                const customIdParts = interaction.customId.split('_');
                const action = customIdParts[1]; // attack, defend, special, flee, fight
                const userId = interaction.user.id;
                const userData = await database.getUser(userId);
                
                if (!userData) {
                    return interaction.reply({
                        content: '‚ùå You need to register first! Use `/register` to begin your pirate adventure.',
                        ephemeral: true
                    });
                }
                
                const combatSystem = require('./systems/combatSystem.js');
                const config = require('./config.js');
                const { EmbedBuilder } = require('discord.js');
                
                // Handle initial fight button from exploration
                if (action === 'fight') {
                    const enemyId = customIdParts[2]; // Get enemy ID from custom ID
                    const enemies = require('./data/enemies.js');
                    
                    // Get the enemy data - for now we'll generate a new enemy since we don't store the original
                    // In a full implementation, you'd store the encounter data temporarily
                    const enemy = enemies.generateEnemyForLevel(userData.level, userData.currentLocation);
                    
                    // Start the combat session
                    const combatSession = await combatSystem.startCombat(userId, enemy);
                    
                    if (!combatSession) {
                        return interaction.reply({
                            content: '‚ùå Failed to start combat session!',
                            ephemeral: true
                        });
                    }
                    
                    // Create combat embed and buttons
                    const combatEmbed = combatSystem.createCombatEmbed(combatSession, userData);
                    const combatButtons = combatSystem.createCombatButtons(combatSession);
                    
                    return interaction.update({
                        embeds: [combatEmbed],
                        components: combatButtons
                    });
                }
                
                // Handle flee button from exploration (before combat starts)
                if (action === 'flee') {
                    const { EmbedBuilder } = require('discord.js');
                    const config = require('./config.js');
                    const randomizer = require('./utils/randomizer.js');
                    
                    // Calculate flee chance
                    const fleeChance = 50 + (userData.level * 2); // Higher level = better flee chance
                    const success = randomizer.rollPercentage(Math.min(fleeChance, 80));
                    
                    const fleeEmbed = new EmbedBuilder()
                        .setColor(success ? config.COLORS.SUCCESS : config.COLORS.WARNING)
                        .setTitle(success ? 'üèÉ Successfully Escaped!' : 'üö´ Escape Failed!')
                        .setDescription(success ? 
                            'You quickly fled from the encounter and avoided the battle!' :
                            'You tried to flee but the enemy blocked your escape! You must fight!')
                    
                    if (success) {
                        // Successful flee - just show the result
                        return interaction.update({
                            embeds: [fleeEmbed],
                            components: []
                        });
                    } else {
                        // Failed flee - start combat automatically
                        const enemies = require('./data/enemies.js');
                        const enemy = enemies.generateEnemyForLevel(userData.level, userData.currentLocation);
                        
                        const combatSession = await combatSystem.startCombat(userId, enemy);
                        if (!combatSession) {
                            return interaction.reply({
                                content: '‚ùå Failed to start combat session!',
                                ephemeral: true
                            });
                        }
                        
                        const combatEmbed = combatSystem.createCombatEmbed(combatSession, userData);
                        const combatButtons = combatSystem.createCombatButtons(combatSession);
                        
                        // Add the flee attempt message to the combat embed
                        combatEmbed.addFields({
                            name: 'üèÉ Flee Attempt Failed',
                            value: 'You tried to escape but the enemy blocked your path! Now you must fight!'
                        });
                        
                        return interaction.update({
                            embeds: [combatEmbed],
                            components: combatButtons
                        });
                    }
                }
                
                // Process regular combat actions
                const result = combatSystem.processCombatAction(userId, action, userData);
                
                if (!result.success) {
                    return interaction.reply({
                        content: `‚ùå ${result.error}`,
                        ephemeral: true
                    });
                }
                
                // Update user data in database
                database.updateUser(userId, userData);
                
                // Create response embed based on action result
                let responseEmbed;
                let components = [];
                
                if (result.result.combatEnd) {
                    // Combat ended - show results
                    const endResult = result.result.combatEnd;
                    responseEmbed = new EmbedBuilder()
                        .setColor(endResult.result === 'victory' ? config.COLORS.SUCCESS : 
                                 endResult.result === 'defeat' ? config.COLORS.ERROR : config.COLORS.WARNING)
                        .setTitle(endResult.result === 'victory' ? 'üèÜ Victory!' : 
                                 endResult.result === 'defeat' ? 'üíÄ Defeat!' : 'üèÉ Fled!')
                        .setDescription(endResult.result === 'victory' ? 'You emerged victorious from the battle!' :
                                       endResult.result === 'defeat' ? 'You were defeated in battle...' :
                                       'You successfully escaped from the battle!');
                    
                    if (endResult.rewards) {
                        responseEmbed.addFields(
                            { name: 'üí∞ Berries Earned', value: `‚Çø${endResult.rewards.berries.toLocaleString()}`, inline: true },
                            { name: '‚≠ê Experience Gained', value: `${endResult.rewards.experience} XP`, inline: true }
                        );
                    }
                    
                    if (endResult.levelUp) {
                        responseEmbed.addFields({
                            name: 'üéâ Level Up!',
                            value: `Level ${endResult.levelUp.oldLevel} ‚Üí ${endResult.levelUp.newLevel}\n+${endResult.levelUp.healthGain} Health\n+${endResult.levelUp.attackGain} Attack\n+${endResult.levelUp.defenseGain} Defense`
                        });
                    }
                    
                    if (endResult.penalties) {
                        responseEmbed.addFields({
                            name: 'üí∏ Penalties',
                            value: `Lost ${endResult.penalties.berryLoss} berries\nHealth reduced to ${userData.health}`
                        });
                    }
                    
                } else {
                    // Combat continues - show updated battle state
                    responseEmbed = combatSystem.createCombatEmbed(result.combat, userData);
                    components = combatSystem.createCombatButtons(result.combat);
                    
                    // Add action result to embed
                    const actionResult = result.result;
                    let actionText = '';
                    
                    if (actionResult.action === 'attack') {
                        actionText = `‚öîÔ∏è You dealt **${actionResult.damage}** damage!`;
                    } else if (actionResult.action === 'defend') {
                        actionText = `üõ°Ô∏è ${actionResult.message}`;
                    } else if (actionResult.action === 'special') {
                        if (actionResult.failed) {
                            actionText = `‚ùå ${actionResult.message}`;
                        } else {
                            actionText = `üîÆ You used **${actionResult.devilFruit.name}** and dealt **${actionResult.damage}** damage!`;
                        }
                    } else if (actionResult.action === 'flee') {
                        actionText = actionResult.fled ? 'üèÉ You successfully escaped!' : `‚ùå ${actionResult.message}`;
                    }
                    
                    if (actionResult.enemyAction) {
                        const enemyAction = actionResult.enemyAction;
                        if (enemyAction.action === 'attack') {
                            actionText += `\nüëπ ${result.combat.enemy.name} dealt **${enemyAction.damage}** damage to you!`;
                        } else if (enemyAction.action === 'defend') {
                            actionText += `\nüõ°Ô∏è ${enemyAction.message}`;
                        }
                    }
                    
                    responseEmbed.addFields({ name: 'üìú Battle Log', value: actionText });
                }
                
                await interaction.update({
                    embeds: [responseEmbed],
                    components: components
                });
                
            } catch (error) {
                console.error('[ERROR] Error handling combat action:', error);
                await interaction.reply({
                    content: '‚ùå There was an error processing your combat action!',
                    ephemeral: true
                });
            }
        }
        // Handle shop pagination buttons
        else if (interaction.customId.startsWith('shop_page_')) {
            try {
                const page = parseInt(interaction.customId.split('_')[2]);
                const userId = interaction.user.id;
                const userData = await database.getUser(userId);
                
                if (!userData) {
                    return interaction.reply({
                        content: '‚ùå You need to register first! Use `/register` to begin your pirate adventure.',
                        ephemeral: true
                    });
                }
                
                const economySystem = require('./systems/economySystem.js');
                const config = require('./config.js');
                const { ActionRowBuilder, ButtonBuilder, ButtonStyle } = require('discord.js');
                
                // Create shop embed for the requested category page
                const totalCategories = 7; // Number of categories we have
                const embed = createCategorizedShopEmbedForButton(page, userData.berries);
                
                // Create navigation buttons
                let components = [];
                if (totalCategories > 1) {
                    const row = new ActionRowBuilder()
                        .addComponents(
                            new ButtonBuilder()
                                .setCustomId(`shop_page_${Math.max(0, page - 1)}`)
                                .setLabel('‚óÄÔ∏è Previous')
                                .setStyle(ButtonStyle.Secondary)
                                .setDisabled(page === 0),
                            new ButtonBuilder()
                                .setCustomId(`shop_page_${Math.min(totalCategories - 1, page + 1)}`)
                                .setLabel('Next ‚ñ∂Ô∏è')
                                .setStyle(ButtonStyle.Secondary)
                                .setDisabled(page === totalCategories - 1)
                        );
                    components.push(row);
                }

                function createCategorizedShopEmbedForButton(categoryPage, userBerries) {
                    const categories = [
                        { key: 'accessory', name: 'üíç Accessories', description: 'Rings, bandanas, and special items that provide stat bonuses' },
                        { key: 'weapon', name: '‚öîÔ∏è Weapons', description: 'Swords, cutlasses, and other combat weapons' },
                        { key: 'armor', name: 'üõ°Ô∏è Armor', description: 'Protective gear including vests, coats, and suits' },
                        { key: 'food', name: 'üçñ Food & Drink', description: 'Consumable items that provide healing and temporary buffs' },
                        { key: 'consumable', name: 'üß™ Consumables', description: 'Single-use items with various effects' },
                        { key: 'tool', name: 'üîß Tools', description: 'Navigation and utility items for exploration' },
                        { key: 'material', name: 'üíé Materials', description: 'Rare materials and crafting components' }
                    ];
                    const currentCategory = categories[categoryPage];
                    const shopItems = economySystem.getShopItems();
                    
                    // Get items for current category
                    const categoryItems = shopItems.filter(item => {
                        const itemType = item.type || 'material';
                        return itemType === currentCategory.key;
                    });
                    
                    const { EmbedBuilder } = require('discord.js');
                    const embed = new EmbedBuilder()
                        .setColor(config.COLORS.PRIMARY)
                        .setTitle(`üè™ ${currentCategory.name}`)
                        .setDescription(currentCategory.description)
                        .addFields({ name: 'üí∞ Your Berries', value: `‚Çø${userBerries.toLocaleString()}`, inline: true });
                    
                    if (categoryItems.length === 0) {
                        embed.addFields({
                            name: 'üì¶ No Items Available',
                            value: 'This category is currently empty. Check back later!',
                            inline: false
                        });
                    } else {
                        // Add each item with full details
                        categoryItems.forEach(item => {
                            const affordable = userBerries >= item.price ? '‚úÖ' : '‚ùå';
                            let itemValue = `**‚Çø${item.price.toLocaleString()}**\n${item.description}`;
                            
                            // Add stat bonuses if available
                            if (item.stats) {
                                let statText = '';
                                if (item.stats.attack > 0) statText += `+${item.stats.attack} Attack `;
                                if (item.stats.defense > 0) statText += `+${item.stats.defense} Defense `;
                                if (item.stats.health > 0) statText += `+${item.stats.health} Health `;
                                if (statText) itemValue += `\nüìà ${statText.trim()}`;
                            }
                            
                            // Add food effects if available
                            if (item.effects) {
                                let effectText = '';
                                if (item.effects.heal) effectText += `+${item.effects.heal} HP `;
                                if (item.effects.attack) effectText += `+${item.effects.attack} ATK `;
                                if (item.effects.defense) effectText += `+${item.effects.defense} DEF `;
                                if (effectText && item.duration) {
                                    const duration = Math.floor(item.duration / 60000);
                                    effectText += `(${duration}min)`;
                                }
                                if (effectText) itemValue += `\nüéä ${effectText.trim()}`;
                            }
                            
                            // Add special properties
                            if (item.special) {
                                itemValue += `\n‚ú® ${item.special}`;
                            }
                            
                            // Add rarity indicator
                            const rarityEmojis = {
                                'common': '‚ö™',
                                'uncommon': 'üü¢', 
                                'rare': 'üîµ',
                                'epic': 'üü£',
                                'legendary': 'üü°'
                            };
                            const rarityEmoji = rarityEmojis[item.rarity] || '‚ö™';
                            
                            embed.addFields({
                                name: `${affordable} ${rarityEmoji} ${item.name}`,
                                value: itemValue,
                                inline: false
                            });
                        });
                    }
                    
                    embed.setFooter({ 
                        text: `Page ${categoryPage + 1}/${categories.length} ‚Ä¢ Use /shop buy <item> to purchase`
                    });
                    
                    return embed;
                }
                
                await interaction.update({
                    embeds: [embed],
                    components: components
                });
                
            } catch (error) {
                console.error('[ERROR] Error handling shop page navigation:', error);
                await interaction.reply({
                    content: '‚ùå There was an error loading that shop page!',
                    ephemeral: true
                });
            }
        }
    }
    
    // Handle select menu interactions
    else if (interaction.isStringSelectMenu()) {
        if (interaction.customId === 'wiki_navigation') {
            try {
                // Import the wiki pages data directly
                const { EmbedBuilder, ActionRowBuilder, StringSelectMenuBuilder } = require('discord.js');
                const config = require('./config.js');
                
                const wikiPages = {
                    overview: {
                        title: 'üè¥‚Äç‚ò†Ô∏è One Piece RPG - Game Overview',
                        description: 'Welcome to the One Piece RPG Discord Bot! Set sail on your pirate adventure in the world of One Piece.',
                        fields: [
                            {
                                name: 'üéÆ What is this game?',
                                value: 'An RPG adventure where you create your pirate character, explore the Grand Line, battle enemies, collect Devil Fruits, form crews, and hunt for the legendary One Piece treasure!',
                                inline: false
                            },
                            {
                                name: 'üöÄ Getting Started',
                                value: '1. Use `/register` to create your pirate\n2. Check your stats with `/profile`\n3. Start exploring with `/explore`\n4. Build your legend!',
                                inline: false
                            },
                            {
                                name: 'üó∫Ô∏è World Progression',
                                value: '**East Blue** (Lv.1-15) ‚Üí **Grand Line** (Lv.16-50) ‚Üí **New World** (Lv.51-100)',
                                inline: false
                            },
                            {
                                name: 'üìä Core Stats',
                                value: '**‚ù§Ô∏è Health**: Your life force\n**‚öîÔ∏è Attack**: Damage you deal\n**üõ°Ô∏è Defense**: Damage reduction\n**‚≠ê Level**: Overall progression',
                                inline: false
                            }
                        ]
                    },
                    commands: {
                        title: 'üìñ Command Reference Guide',
                        description: 'Complete list of all available commands and their usage.',
                        fields: [
                            {
                                name: 'üë§ Character Commands',
                                value: '`/register` - Create your pirate character\n`/profile` - View your character stats\n`/profile @user` - View another player\'s profile',
                                inline: false
                            },
                            {
                                name: 'üó∫Ô∏è Adventure Commands', 
                                value: '`/explore` - Explore new locations and encounter adventures\n`/combat` - Engage in turn-based battles\n`/treasure` - Search for hidden treasures',
                                inline: false
                            },
                            {
                                name: 'üçé Devil Fruit Commands',
                                value: '`/devilfruit search` - Search for Devil Fruits\n`/devilfruit train` - Train your Devil Fruit powers\n`/devilfruit list` - View available Devil Fruits',
                                inline: false
                            },
                            {
                                name: 'üí∞ Economy Commands',
                                value: '`/shop` - Browse and buy items\n`/shop buy <item>` - Purchase specific items\n`/shop sell <item>` - Sell items from inventory',
                                inline: false
                            },
                            {
                                name: 'üë• Crew Commands',
                                value: '`/crew create <name>` - Form a new pirate crew\n`/crew join <name>` - Join an existing crew\n`/crew info` - View crew information\n`/crew leave` - Leave your current crew',
                                inline: false
                            },
                            {
                                name: '‚ùì Help Commands',
                                value: '`/help` - Quick command overview\n`/wiki` - This comprehensive guide\n`/guide` - Alternative to /wiki',
                                inline: false
                            }
                        ]
                    },
                    combat: {
                        title: '‚öîÔ∏è Combat System Guide',
                        description: 'Master the art of battle in the One Piece world.',
                        fields: [
                            {
                                name: 'üéØ Combat Basics',
                                value: 'Combat is **turn-based** where you and your enemy take turns attacking until one is defeated.',
                                inline: false
                            },
                            {
                                name: 'üí• Damage Calculation',
                                value: '**Damage = Your Attack - Enemy Defense**\nHigher attack deals more damage, higher defense reduces incoming damage.',
                                inline: false
                            },
                            {
                                name: 'üé≤ Combat Actions',
                                value: '**Attack** - Deal damage to enemy\n**Defend** - Reduce incoming damage next turn\n**Special** - Use Devil Fruit abilities (if available)',
                                inline: false
                            },
                            {
                                name: 'üèÜ Victory Rewards',
                                value: '**Experience Points**: Level up and increase stats\n**Berries**: Currency for buying items\n**Item Drops**: Random equipment and materials',
                                inline: false
                            },
                            {
                                name: '‚ö° Critical Hits',
                                value: 'Random chance to deal **2x damage** on attacks. Higher level increases crit chance.',
                                inline: false
                            },
                            {
                                name: 'üîÑ Combat Cooldown',
                                value: `Combat has a **${config.COMBAT_COOLDOWN/1000} second cooldown** between battles to prevent spam.`,
                                inline: false
                            }
                        ]
                    },
                    exploration: {
                        title: 'üó∫Ô∏è Exploration System Guide', 
                        description: 'Discover the vast world of One Piece through exploration.',
                        fields: [
                            {
                                name: 'üåç How Exploration Works',
                                value: 'Use `/explore` to venture into new areas and discover random encounters based on your level.',
                                inline: false
                            },
                            {
                                name: 'üé≤ Possible Encounters',
                                value: '**üè¥‚Äç‚ò†Ô∏è Enemy Battles** (60%) - Fight pirates, marines, and monsters\n**üëë Ally Meetings** (10%) - Meet One Piece characters\n**üíé Treasure Discovery** (15%) - Find berries and items\n**üçé Devil Fruit Hunt** (2%) - Rare Devil Fruit encounters',
                                inline: false
                            },
                            {
                                name: 'üìç Location Progression',
                                value: '**East Blue** ‚Üí Foosha Village, Shells Town, Orange Town\n**Grand Line** ‚Üí Whisky Peak, Alabasta, Skypiea\n**New World** ‚Üí Fishman Island, Dressrosa, Wano',
                                inline: false
                            },
                            {
                                name: '‚ö†Ô∏è Danger Levels',
                                value: '**Very Low** üü¢ **Low** üü° **Moderate** üü† **High** üî¥ **Extreme** ‚ö´ **Legendary** üü£',
                                inline: false
                            },
                            {
                                name: '‚è±Ô∏è Exploration Cooldown',
                                value: `**${config.EXPLORE_COOLDOWN/1000} seconds** between explorations to maintain game balance.`,
                                inline: false
                            }
                        ]
                    },
                    devilfruits: {
                        title: 'üçé Devil Fruit System Guide',
                        description: 'Harness the mysterious powers of Devil Fruits.',
                        fields: [
                            {
                                name: 'üîç Finding Devil Fruits',
                                value: 'Devil Fruits are **extremely rare** (2% chance) and can be found through:\n‚Ä¢ Exploration encounters\n‚Ä¢ Defeating powerful enemies\n‚Ä¢ Special treasure hunts',
                                inline: false
                            },
                            {
                                name: 'üìö Devil Fruit Types',
                                value: '**Paramecia** - Superhuman abilities\n**Zoan** - Animal transformations\n**Logia** - Elemental control powers',
                                inline: false
                            },
                            {
                                name: '‚≠ê Rarity System',
                                value: '**Common** ‚Üí **Uncommon** ‚Üí **Rare** ‚Üí **Epic** ‚Üí **Mythical** ‚Üí **Legendary**\nRarer fruits provide stronger stat bonuses and unique abilities.',
                                inline: false
                            },
                            {
                                name: 'üí™ Training Powers',
                                value: 'Use `/devilfruit train` to increase your Devil Fruit mastery and unlock new abilities. Training costs berries but greatly increases your power.',
                                inline: false
                            },
                            {
                                name: 'üåä Devil Fruit Weakness',
                                value: 'Remember: Devil Fruit users lose their ability to swim! This affects certain exploration encounters.',
                                inline: false
                            },
                            {
                                name: '‚è±Ô∏è Training Cooldown',
                                value: `**${config.DEVIL_FRUIT_COOLDOWN/1000/60} minutes** between training sessions.`,
                                inline: false
                            }
                        ]
                    },
                    economy: {
                        title: 'üí∞ Economy & Items Guide',
                        description: 'Master the economic systems and item management.',
                        fields: [
                            {
                                name: 'üíé Berries (‚Çø) - Currency',
                                value: `Everyone starts with **‚Çø${config.STARTING_BERRIES.toLocaleString()}**. Earn more through:\n‚Ä¢ Winning battles\n‚Ä¢ Finding treasures\n‚Ä¢ Selling items\n‚Ä¢ Completing crew activities`,
                                inline: false
                            },
                            {
                                name: 'üõçÔ∏è Shop System',
                                value: '**Weapons** ‚öîÔ∏è - Increase attack power\n**Armor** üõ°Ô∏è - Boost defense and health\n**Accessories** üíç - Balanced stat bonuses\n**Consumables** üß™ - Temporary effects\n**Tools** üîß - Special utilities',
                                inline: false
                            },
                            {
                                name: 'üìä Item Rarity & Pricing',
                                value: '**Common** (Gray) - Basic items, affordable\n**Uncommon** (Green) - Decent upgrades\n**Rare** (Blue) - Significant improvements\n**Epic** (Purple) - Powerful equipment\n**Legendary** (Gold) - End-game gear',
                                inline: false
                            },
                            {
                                name: 'üéí Equipment Slots',
                                value: 'You can equip:\n‚Ä¢ **1 Weapon** for maximum attack\n‚Ä¢ **1 Armor** for defense\n‚Ä¢ **1 Accessory** for balanced stats\n‚Ä¢ **Consumables** for temporary boosts',
                                inline: false
                            },
                            {
                                name: 'üí∏ Selling Strategy',
                                value: 'Items sell for **60% of purchase price**. Keep better items and sell outdated equipment for berries.',
                                inline: false
                            }
                        ]
                    },
                    crews: {
                        title: 'üë• Crew System Guide',
                        description: 'Unite with other pirates to build a legendary crew.',
                        fields: [
                            {
                                name: 'üè¥‚Äç‚ò†Ô∏è Creating a Crew',
                                value: 'Use `/crew create <name>` to form your own pirate crew. You become the **Captain** with full control over crew activities.',
                                inline: false
                            },
                            {
                                name: '‚öì Joining a Crew',
                                value: 'Use `/crew join <name>` to request joining an existing crew. The captain must accept your request.',
                                inline: false
                            },
                            {
                                name: 'üëë Crew Roles',
                                value: '**Captain** üëë - Full crew management control\n**Member** ‚öì - Participate in crew activities\n**Officer** ‚≠ê - Limited management abilities (future feature)',
                                inline: false
                            },
                            {
                                name: 'üìà Crew Benefits',
                                value: '‚Ä¢ **Shared Treasury** for group purchases\n‚Ä¢ **Reputation System** for crew fame\n‚Ä¢ **Territory Control** for resource bonuses\n‚Ä¢ **Group Adventures** and special events',
                                inline: false
                            },
                            {
                                name: 'üèÜ Crew Progression',
                                value: 'Crews level up through member activities:\n‚Ä¢ Member battles and exploration\n‚Ä¢ Collective treasure hunting\n‚Ä¢ Territory conquests\n‚Ä¢ Special crew missions',
                                inline: false
                            },
                            {
                                name: 'üó∫Ô∏è Territory System',
                                value: 'High-level crews can claim territories for:\n‚Ä¢ **Resource Bonuses** for all members\n‚Ä¢ **Exclusive Hunting Grounds**\n‚Ä¢ **Strategic Advantages** in conflicts',
                                inline: false
                            }
                        ]
                    },
                    strategy: {
                        title: 'üß† Strategy & Tips Guide',
                        description: 'Pro tips to become the Pirate King.',
                        fields: [
                            {
                                name: 'üéØ Early Game Strategy (Lv.1-15)',
                                value: '‚Ä¢ Focus on **exploration** for XP and berries\n‚Ä¢ Buy basic equipment from shop\n‚Ä¢ Join or create a crew for support\n‚Ä¢ Save berries for better gear',
                                inline: false
                            },
                            {
                                name: '‚ö° Mid Game Strategy (Lv.16-50)', 
                                value: '‚Ä¢ Hunt for **Devil Fruits** actively\n‚Ä¢ Upgrade to rare/epic equipment\n‚Ä¢ Focus on crew reputation building\n‚Ä¢ Challenge stronger enemies for better rewards',
                                inline: false
                            },
                            {
                                name: 'üëë Late Game Strategy (Lv.51+)',
                                value: '‚Ä¢ Master Devil Fruit abilities fully\n‚Ä¢ Collect legendary equipment\n‚Ä¢ Lead territorial conquests\n‚Ä¢ Aim for the **One Piece** ultimate goal',
                                inline: false
                            },
                            {
                                name: 'üí° Combat Tips',
                                value: '‚Ä¢ **Defend** before big enemy attacks\n‚Ä¢ Use **special abilities** strategically\n‚Ä¢ Higher level = more critical hits\n‚Ä¢ Equipment makes huge differences',
                                inline: false
                            },
                            {
                                name: 'üé≤ RNG Management',
                                value: '‚Ä¢ Exploration has **cooldowns** - use them wisely\n‚Ä¢ **Treasure hunting** has best berry/time ratio\n‚Ä¢ Devil Fruit searches are rare but worthwhile\n‚Ä¢ Crew activities provide consistent progress',
                                inline: false
                            },
                            {
                                name: 'üè¥‚Äç‚ò†Ô∏è Path to Pirate King',
                                value: '‚Ä¢ Reach **Level 100**\n‚Ä¢ Master a **Legendary Devil Fruit**\n‚Ä¢ Lead a **Max Level Crew**\n‚Ä¢ Control multiple **Territories**\n‚Ä¢ Find the **One Piece**',
                                inline: false
                            }
                        ]
                    }
                };
                
                const selectedPage = interaction.values[0];
                const pageData = wikiPages[selectedPage];
                
                if (!pageData) {
                    return interaction.update({
                        content: '‚ùå Invalid wiki page selected!',
                        embeds: [],
                        components: [],
                        ephemeral: true
                    });
                }
                
                // Create the embed
                const embed = new EmbedBuilder()
                    .setColor(config.COLORS.PRIMARY)
                    .setTitle(pageData.title)
                    .setDescription(pageData.description)
                    .addFields(pageData.fields)
                    .setFooter({ 
                        text: 'Use the dropdown menu below to navigate between guide pages',
                        iconURL: interaction.client.user.displayAvatarURL()
                    })
                    .setTimestamp();

                // Recreate navigation dropdown
                const navigationMenu = new StringSelectMenuBuilder()
                    .setCustomId('wiki_navigation')
                    .setPlaceholder('üìö Select a guide page...')
                    .addOptions([
                        {
                            label: 'Game Overview',
                            description: 'Basic introduction to the One Piece RPG',
                            value: 'overview',
                            emoji: 'üè¥‚Äç‚ò†Ô∏è'
                        },
                        {
                            label: 'Commands Reference',
                            description: 'Complete list of all available commands',
                            value: 'commands',
                            emoji: 'üìñ'
                        },
                        {
                            label: 'Combat System',
                            description: 'Learn how battles and combat work',
                            value: 'combat',
                            emoji: '‚öîÔ∏è'
                        },
                        {
                            label: 'Exploration Guide',
                            description: 'Discover locations and encounters',
                            value: 'exploration',
                            emoji: 'üó∫Ô∏è'
                        },
                        {
                            label: 'Devil Fruits',
                            description: 'Everything about Devil Fruit powers',
                            value: 'devilfruits',
                            emoji: 'üçé'
                        },
                        {
                            label: 'Economy & Items',
                            description: 'Berries, shop, and equipment guide',
                            value: 'economy',
                            emoji: 'üí∞'
                        },
                        {
                            label: 'Crew System',
                            description: 'Form and manage pirate crews',
                            value: 'crews',
                            emoji: 'üë•'
                        },
                        {
                            label: 'Strategy & Tips',
                            description: 'Pro tips to become Pirate King',
                            value: 'strategy',
                            emoji: 'üß†'
                        }
                    ]);

                const row = new ActionRowBuilder().addComponents(navigationMenu);

                await interaction.update({
                    embeds: [embed],
                    components: [row]
                });
                
            } catch (error) {
                console.error('[ERROR] Error handling wiki navigation:', error);
                
                // Check if interaction has already been handled
                if (!interaction.replied && !interaction.deferred) {
                    await interaction.reply({
                        content: '‚ùå There was an error loading that wiki page!',
                        ephemeral: true
                    });
                }
            }
        }
    }
});

// Error handling
client.on('error', error => {
    console.error('[ERROR] Discord client error:', error);
});

process.on('unhandledRejection', error => {
    console.error('[ERROR] Unhandled promise rejection:', error);
});

process.on('uncaughtException', error => {
    console.error('[ERROR] Uncaught exception:', error);
    process.exit(1);
});

// Login to Discord
client.login(config.DISCORD_TOKEN);
